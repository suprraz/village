<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Village Payment Page</title>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bulmaswatch/solar/bulmaswatch.min.css">
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js" type="text/javascript"></script>

    <script type="text/javascript">
      class _Payment {
        #params
        #secondsLeft = 10 * 60 * 1000;
        #appName
        #price
        #timer
        #walletLink

        constructor() {

          if(params) {
            const paramsJson = atob(params);
            try {
              const paramsObj = JSON.parse(paramsJson);
              this.#params = {...paramsObj};
            } catch (e) {
            }
          }

          document.addEventListener('DOMContentLoaded', () => {
            const placeholder = document.getElementById('placeholder');
            const payment = document.getElementById('payment');
            this.#timer = document.getElementById('timer');
            this.#appName = document.getElementById('appName');
            this.#price = document.getElementById('price');
            this.#walletLink = document.getElementById('walletLink');

            payment.removeAttribute('style');
            placeholder.remove();

            this.start();
          }, false);
        }

        async start() {
          const invoice = await this.createInvoice(this.#params.paywall);

          this.#appName.innerText = this.#params.appName;
          this.#price.innerText = this.#params.paywall.amount + ' Sats';
          const link = `lightning:${invoice.payment_request}`;

          this.#walletLink.setAttribute('href', link);

          new QRCode(document.getElementById("qrcode"), invoice.payment_request);

          this.updateTimer();

          let url = null;
          try {
            const status = await this.waitForPayment(this.#params.paywall, invoice);

            url = status.url;
          } catch (e) {
            alert(e.message)
          }

          const urlObj = new URL(url);
          const urlParams = new URLSearchParams(urlObj.search);

          if (urlParams.has('encryptionKey') && urlParams.has('appId')) {
            window.parent.postMessage({type: 'closeApp', payload: {sourceApp: 'PaymentApp'}}, '*');
            window.parent.postMessage({
              type: 'invoicePaid',
              payload: {decryptApp: true, encryptionKey: urlParams.get('encryptionKey'), appId: urlParams.get('appId')}
            }, '*');
          }

        }

        async createInvoice(paywall) {
          try {
            const res = await fetch('https://legend.lnbits.com/paywall/api/v1/paywalls/invoice/' + paywall.id, {
              headers: {
                "Content-Type": "application/json",
                "X-Api-Key": this.#params.apiKey
              },
              body: JSON.stringify(
                {
                  "amount": paywall.amount,
                }
              ),
              method: "POST"
            });

            return await res.json();
          } catch (e) {
            alert("Failed to generate invoice. Please check payment settings.")
          }
        }

        async checkInvoice(paywall, invoice) {
          try {
            const res = await fetch('https://legend.lnbits.com/paywall/api/v1/paywalls/check_invoice/' + paywall.id, {
              headers: {
                "Content-Type": "application/json",
                "X-Api-Key": this.#params.apiKey
              },
              body: JSON.stringify(
                {
                  "payment_hash": invoice.payment_hash,
                }
              ),
              method: "POST"
            });

            return  await res.json();
          } catch (e) {
            alert("Failed to check invoice: " + e);
          }
        }


        async waitForPayment(paywall, invoice) {
          const minutesToAdd = 5;
          const currentDate = new Date();
          const timeoutDate = new Date(currentDate.getTime() + minutesToAdd * 60000);

          function wait(ms) {
            return new Promise(resolve => {
              setTimeout(resolve, ms);
            });
          }

          let status = await this.checkInvoice(paywall, invoice);
          while (status.paid !== true) {
            if (timeoutDate < new Date()) {
              throw new Error('Waiting for payment timed out.')
            }
            await wait(1000);
            status = await this.checkInvoice(paywall, invoice)
          }

          return status;
        }

        updateTimer() {
          if (this.#secondsLeft > 0) {
            this.#secondsLeft = this.#secondsLeft - 1000;
            const minutes = Math.floor(this.#secondsLeft / 60000);
            const seconds =  (this.#secondsLeft % 60000) / 1000;

            this.#timer.innerText = minutes + (seconds < 10 ? ':0': ':') + seconds;
            setTimeout(() => this.updateTimer(), 1000);
          } else {
            this.#timer.innerText = 'Invoice expired.';
          }
        }
      }

      new _Payment();
    </script>
</head>

<body>
<div id="placeholder" style='background-color: #0a0a0a; height: 100%;'></div>
<div id="payment" style='display: none;'>
    <section class="section">

        <h1 class="title">
            App purchase
        </h1>
        <div><span id="appName" class="subtitle"></span> : <span id="price" class="subtitle"></span></div>

    </section>

    <section class="section is-medium mx-1">

        <div><a id="walletLink" class="is-link my-4 is-size-4" href="#" target="_system">Open Wallet</a></div>

        <div>Expires in <span id="timer">10:00</span></div>

        <section class="container mt-5">
            <div id="qrcode"></div>

        </section>
    </section>

</div>
</body>
</html>
