<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Editor</title>
    <style media="screen">
        #editor {
            position: absolute;
            top: 56px;
            right: 20px;
            bottom: 0;
            left: 20px;
        }

        @media only screen and (max-width: 830px) {
            #editor {
                top: 76px;
            }
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bulmaswatch/solar/bulmaswatch.min.css">
    <script src="https://unpkg.com/ace-builds@1.6/src-min-noconflict/ace.js" charset="utf-8"
            type="text/javascript"></script>

    <script type="text/javascript">
      class _AceEditor {
        #params
        #editorEl
        #editor

        constructor() {
          if (params) {
            const paramsJson = atob(params);
            try {
              const paramsObj = JSON.parse(paramsJson);
              this.#params = {...paramsObj};
            } catch (e) {
            }
          }

          document.addEventListener('DOMContentLoaded', () => {
            this.#editorEl = document.getElementById('editor');

            this.init();
          }, false);
        }

        init() {
          this.#editor = ace.edit("editor", {
            mode: "ace/mode/html",
            selectionStyle: "text"
          });

          this.#editor.setTheme("ace/theme/twilight");
          this.#editor.session.setMode("ace/mode/javascript");

          this.#editorEl.classList.remove("is-hidden");

          if (this.#params?.app?.code) {
            this.#editor.session.setValue(this.#params.app.code);
          }
          if (this.#params?.app?.name) {
            document.getElementById('appName').value = this.#params.app.name;
          }

          if (typeof this.#params?.app?.price === "string") {
            document.getElementById('appPrice').value = this.#params.app.price;
          }
          const saveBtn = document.getElementById('saveBtn');
          saveBtn.addEventListener('click', () => this.saveAndRun(false));

          const runBtn = document.getElementById('runBtn');
          runBtn.addEventListener('click', () => this.saveAndRun(true));
        }

        saveAndRun(runAfterSave) {
          const code = this.#editor.session.getValue();
          const name = document.getElementById('appName').value;
          const price = document.getElementById('appPrice').value;

          if (Number.isNaN(parseFloat(price)) || parseFloat(price) <= 0) {
            window.parent.postMessage({type: 'alert', payload: {alertMsg: 'Please enter a valid price'}}, '*');
            return;
          }

          if (!name.length) {
            window.parent.postMessage({type: 'alert', payload: {alertMsg: 'Please enter a valid app name'}}, '*');
            return;
          }

          const app = {
            ...this.#params.app,
            name,
            code,
            price
          }

          window.parent.postMessage({type: 'saveAndRunApp', payload: {app, runAfterSave}}, '*');
        }
      }

      new _AceEditor();
    </script>

</head>
<body>
<div class="px-4 py-4">
    <div class="">
        <div class="is-flex">
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label">Name</label>
                </div>
                <div class="field-body">
                    <div class="field">
                        <p class="control">
                            <input type="text" class="input is-static" name="appName" id="appName"
                                   placeholder="App name"/>
                        </p>
                    </div>
                </div>
            </div>

            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label">Price (Sats)</label>
                </div>
                <div class="field-body">
                    <div class="field">
                        <p class="control">
                            <input type="text" class="input is-static" name="appPrice" id="appPrice"
                                   placeholder="Price in sats.  0 = free."/>
                        </p>
                    </div>
                </div>
            </div>

            <button id="saveBtn" class="button is-primary mx-1">Save</button>
            <button id="runBtn" class="button is-primary mx-1">Run</button>
        </div>

        <pre id="editor" class="my-4 is-hidden"></pre>
    </div>
</div>
</body>
</html>
